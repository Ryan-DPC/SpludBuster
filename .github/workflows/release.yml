name: Build and Release Game

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  # 1. Build on Windows
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Game
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run build --if-present
          # Fallback for demo if build doesn't create dist
          if (-not (Test-Path dist)) {
             New-Item -ItemType Directory -Force -Path dist
             Set-Content -Path dist/game.exe -Value "Game Build Content"
          }

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: game-dist
          path: dist/
          retention-days: 1

  # 2. Release on Ubuntu (Cloudinary + GitHub Release)
  release:
    needs: build-windows
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: game-dist
          path: dist

      - name: Create Game Zip
        run: |
          cd dist
          zip -r ../game.zip .
          cd ..
          ls -l game.zip

      - name: Install Cloudinary SDK
        run: npm install cloudinary

      - name: Generate Manifest and Upload
        env:
          CLOUDINARY_URL: ${{ secrets.CLOUDINARY_URL }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          node -e '
            const fs = require("fs");
            const crypto = require("crypto");
            const cloudinary = require("cloudinary").v2;

            async function run() {
              try {
                const version = process.env.TAG_NAME;
                const zipPath = "game.zip";
                
                // 1. Calculate Hash and Size
                const fileBuffer = fs.readFileSync(zipPath);
                const hash = crypto.createHash("sha256").update(fileBuffer).digest("hex");
                const stats = fs.statSync(zipPath);
                const size = stats.size;
                const date = new Date().toISOString();

                console.log(`Version: ${version}`);
                console.log(`Size: ${size} bytes`);
                console.log(`Hash: ${hash}`);

                // 2. Upload Game Zip to Cloudinary
                console.log("Uploading game.zip to Cloudinary...");
                const zipUpload = await cloudinary.uploader.upload(zipPath, {
                  resource_type: "raw",
                  public_id: `releases/${version}/game.zip`,
                  overwrite: true
                });
                
                console.log("Game Zip Uploaded:", zipUpload.secure_url);

                // 3. Create Manifest
                const manifest = {
                  version: version,
                  size: size,
                  hash: hash,
                  date: date,
                  downloadUrl: zipUpload.secure_url
                };
                
                fs.writeFileSync("manifest.json", JSON.stringify(manifest, null, 2));
                console.log("manifest.json created.");

                // 4. Upload Manifest to Cloudinary
                console.log("Uploading manifest.json to Cloudinary...");
                const manifestUpload = await cloudinary.uploader.upload("manifest.json", {
                  resource_type: "raw",
                  public_id: `releases/${version}/manifest.json`,
                  overwrite: true
                });
                
                console.log("Manifest Uploaded:", manifestUpload.secure_url);
                
              } catch (error) {
                console.error("Error in script:", error);
                process.exit(1);
              }
            }

            run();
          '

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            game.zip
            manifest.json
          draft: false
          prerelease: false
          generate_release_notes: true
