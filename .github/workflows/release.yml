name: Build and Release Game

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Type de version'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
  push:
    tags:
      - 'v*'

jobs:
  # 1. Create Tag
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: ${{ github.event.inputs.version_bump || 'patch' }}
          WITH_V: true
          RELEASE_BRANCHES: main,master
          TAG_CONTEXT: repo

  # 2. Build on Windows
  build-windows:
    needs: create-tag
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-tag.outputs.new_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Game
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run build --if-present
          # Fallback for demo if build doesn't create dist
          if (-not (Test-Path dist)) {
             New-Item -ItemType Directory -Force -Path dist
             Set-Content -Path dist/game.exe -Value "Game Build Content"
          }

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: game-dist
          path: dist/
          retention-days: 1

  # 3. Release on Ubuntu (Cloudinary + GitHub Release)
  release:
    needs: [create-tag, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-tag.outputs.new_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: game-dist
          path: dist

      - name: Create Game Zip
        run: |
          cd dist
          zip -r ../game.zip .
          cd ..
          ls -l game.zip

      - name: Install Cloudinary SDK
        run: npm install cloudinary
      - name: Generate Manifest and Upload
        env:
          CLOUDINARY_URL: ${{ secrets.CLOUDINARY_URL }}
          TAG_NAME: ${{ needs.create-tag.outputs.new_tag }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          node -e '
            const fs = require("fs");
            const crypto = require("crypto");
            const cloudinary = require("cloudinary").v2;
            let pkg = {};
            try { pkg = require("./package.json"); } catch (e) {}

            async function run() {
              try {
                const version = process.env.TAG_NAME;
                const repo = process.env.GITHUB_REPOSITORY;
                const repoName = repo.split("/")[1]; // ex: "Backend_Ether" -> "Backend_Ether"
                const zipPath = "game.zip";
                
                const fileBuffer = fs.readFileSync(zipPath);
                const hash = crypto.createHash("sha256").update(fileBuffer).digest("hex");
                const stats = fs.statSync(zipPath);
                
                const downloadUrl = `https://github.com/${repo}/releases/download/${version}/game.zip`;

                // Création du manifeste avec les métadonnées requises par le backend
                const manifest = {
                  gameName: pkg.displayName || pkg.name || repoName,
                  description: pkg.description || "",
                  developer: pkg.author || "Unknown",
                  genre: pkg.genre || "Indie",
                  version: version,
                  size: stats.size,
                  hash: hash,
                  date: new Date().toISOString(),
                  downloadUrl: downloadUrl,
                  platform: "exe" // Change à "web" si c est un jeu web
                };
                
                fs.writeFileSync("manifest.json", JSON.stringify(manifest, null, 2));
                
                // Upload vers manifests/{nom_du_repo}.json pour que le backend le trouve
                const publicId = `manifests/${repoName}.json`;
                console.log(`Uploading to ${publicId}...`);
                
                await cloudinary.uploader.upload("manifest.json", {
                  resource_type: "raw",
                  public_id: publicId,
                  overwrite: true
                });
              } catch (error) {
                console.error("FATAL ERROR:", error);
                process.exit(1);
              }
            }
            run();
          '
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-tag.outputs.new_tag }}
          files: |
            game.zip
            manifest.json
          draft: false
          prerelease: false
          generate_release_notes: true
