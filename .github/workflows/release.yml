name: Build and Release Game

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Type de version'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
  push:
    tags:
      - 'v*'

jobs:
  # 1. Create Tag
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: ${{ github.event.inputs.version_bump || 'patch' }}
          WITH_V: true
          RELEASE_BRANCHES: main,master
          TAG_CONTEXT: repo

  # 2. Build on Windows
  build-windows:
    needs: create-tag
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-tag.outputs.new_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Game
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run build --if-present
          # Fallback for demo if build doesn't create dist
          if (-not (Test-Path dist)) {
             New-Item -ItemType Directory -Force -Path dist
             Set-Content -Path dist/game.exe -Value "Game Build Content"
          }

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: game-dist
          path: dist/
          retention-days: 1

  # 3. Release on Ubuntu (Cloudinary + GitHub Release)
  release:
    needs: [create-tag, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-tag.outputs.new_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: game-dist
          path: dist

      - name: Create Game Zip
        run: |
          cd dist
          zip -r ../game.zip .
          cd ..
          ls -l game.zip

      - name: Install Cloudinary SDK
        run: npm install cloudinary

      - name: Generate Manifest and Upload
        env:
          CLOUDINARY_URL: ${{ secrets.CLOUDINARY_URL }}
          TAG_NAME: ${{ needs.create-tag.outputs.new_tag }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          node -e '
            const fs = require("fs");
            const crypto = require("crypto");
            const cloudinary = require("cloudinary").v2;

            async function run() {
              try {
                console.log("Cloudinary SDK Version:", require("cloudinary/package.json").version);
                
                const version = process.env.TAG_NAME;
                const repo = process.env.GITHUB_REPOSITORY;
                const zipPath = "game.zip";
                
                // 1. Calculate Hash and Size
                const fileBuffer = fs.readFileSync(zipPath);
                const hash = crypto.createHash("sha256").update(fileBuffer).digest("hex");
                const stats = fs.statSync(zipPath);
                const size = stats.size;
                const date = new Date().toISOString();

                console.log(`Version: ${version}`);
                console.log(`Size: ${size} bytes`);
                console.log(`Hash: ${hash}`);

                // 2. Construct GitHub Release URL (Cloudinary limit workaround)
                // Cloudinary Free Tier has a 10MB limit for raw files, so we use GitHub Releases for hosting.
                const downloadUrl = `https://github.com/${repo}/releases/download/${version}/game.zip`;
                console.log("Using GitHub Release URL:", downloadUrl);

                // 3. Create Manifest
                const manifest = {
                  version: version,
                  size: size,
                  hash: hash,
                  date: date,
                  downloadUrl: downloadUrl
                };
                
                fs.writeFileSync("manifest.json", JSON.stringify(manifest, null, 2));
                console.log("manifest.json created:", JSON.stringify(manifest, null, 2));

                // 4. Upload Manifest to Cloudinary
                console.log("Uploading manifest.json to Cloudinary...");
                const manifestUpload = await cloudinary.uploader.upload("manifest.json", {
                  resource_type: "raw",
                  public_id: `releases/${version}/manifest.json`,
                  overwrite: true
                });
                
                console.log("Manifest Uploaded:", manifestUpload.secure_url);
                
              } catch (error) {
                console.error("FATAL ERROR in script:", error);
                process.exit(1);
              }
            }

            run();
          '

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-tag.outputs.new_tag }}
          files: |
            game.zip
            manifest.json
          draft: false
          prerelease: false
          generate_release_notes: true
